/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////
///		Copyright 2020 (C) Bruno Xavier B. Leite
//////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "LE_ItemShadows.h"
#include "Components/LightComponent.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define LOCTEXT_NAMESPACE "Synaptech"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

SLE_ItemShadows::SLE_ItemShadows(){}
SLE_ItemShadows::~SLE_ItemShadows(){}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void SLE_ItemShadows::Construct(const FArguments &InArgs, ALight* Target) {
	Item = Target;
	//
	//
	ChildSlot.HAlign(HAlign_Fill).VAlign(VAlign_Fill)
	[
		SNew(SBox)
		.Padding(FMargin(4))
		[
			SNew(SBorder).Padding(FMargin(6))
			.VAlign(VAlign_Fill).HAlign(HAlign_Fill)
			.BorderImage(FEditorStyle::GetBrush("ToolPanel.DarkGroupBorder"))
			[
				SNew(SHorizontalBox)
				+SHorizontalBox::Slot()
				.VAlign(VAlign_Center)
				[
					SNew(STextBlock)
					.Font(FEditorStyle::GetFontStyle(TEXT("BoldFont")))
					.Text(FText::FromString(TEXT("Cast Shadows")))
					.Justification(ETextJustify::Center)
				]
				+SHorizontalBox::Slot().AutoWidth()
				.VAlign(VAlign_Center).HAlign(HAlign_Right)
				[
					SNew(SCheckBox)
					.IsChecked(this,&SLE_ItemShadows::GetState)
					.OnCheckStateChanged(this,&SLE_ItemShadows::OnStateChanged)
				]
			]
		]
	];
}

void SLE_ItemShadows::OnStateChanged(ECheckBoxState NewState) {
	if (!Item.IsValid()) {return;}
	//
	FPropertyChangedEvent PropEditEvent(ULightComponent::StaticClass()->FindPropertyByName(GET_MEMBER_NAME_CHECKED(ULightComponent,CastShadows)));
	EComponentMobility::Type Mobility = Item->GetLightComponent()->Mobility;
	bool CastShadow = (NewState==ECheckBoxState::Checked) ? true : false;
	//
	Item->Modify();
	Item->GetLightComponent()->Mobility = EComponentMobility::Stationary;
	Item->GetLightComponent()->InvalidateLightingCache();
	Item->GetLightComponent()->SetCastShadows(CastShadow);
	Item->GetLightComponent()->MarkRenderStateDirty();
	//
	Item->GetLightComponent()->PostEditChangeProperty(PropEditEvent);
	Item->GetLightComponent()->Mobility = Mobility;
}

ECheckBoxState SLE_ItemShadows::GetState() const {
	if (!Item.IsValid()) {return ECheckBoxState::Undetermined;}
	//
	if (Item->GetLightComponent()->CastShadows) {
		return ECheckBoxState::Checked;
	}	return ECheckBoxState::Unchecked;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#undef LOCTEXT_NAMESPACE

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////