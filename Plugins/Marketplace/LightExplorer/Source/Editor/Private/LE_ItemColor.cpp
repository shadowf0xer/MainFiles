/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////
///		Copyright 2020 (C) Bruno Xavier B. Leite
//////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "LE_ItemColor.h"

#include "Runtime/Core/Public/Misc/Attribute.h"
#include "Runtime/InputCore/Classes/InputCoreTypes.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define LOCTEXT_NAMESPACE "Synaptech"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

SLE_ItemColor::SLE_ItemColor(){}
SLE_ItemColor::~SLE_ItemColor(){}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void SLE_ItemColor::Construct(const FArguments &InArgs, ALight* Target) {
	Item = Target;
	//
	//
	ChildSlot.HAlign(HAlign_Fill).VAlign(VAlign_Fill)
	[
		SNew(SBox)
		.Padding(FMargin(4))
		[
			SNew(SBorder).Padding(FMargin(6))
			.VAlign(VAlign_Fill).HAlign(HAlign_Fill)
			.BorderImage(FEditorStyle::GetBrush("ToolPanel.DarkGroupBorder"))
			[
				SNew(SColorBlock)
				.OnMouseButtonDown(this,&SLE_ItemColor::OnClickedItem)
				.Color(this,&SLE_ItemColor::GetColor)
				.IgnoreAlpha(false)
			]
		]
	];
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

FLinearColor SLE_ItemColor::GetColor() const {
	if (!Item.IsValid()) {return FLinearColor::Black;}
	//
	return Item->GetLightColor();
}

void SLE_ItemColor::SetColor(FLinearColor NewColor) {
	if (!Item.IsValid()) {return;}
	//
	FPropertyChangedEvent PropEditEvent(ULightComponent::StaticClass()->FindPropertyByName(GET_MEMBER_NAME_CHECKED(ULightComponent,LightColor)));
	EComponentMobility::Type Mobility = Item->GetLightComponent()->Mobility;
	//
	Item->Modify();
	Item->GetLightComponent()->Mobility = EComponentMobility::Stationary;
	Item->GetLightComponent()->InvalidateLightingCache();
	Item->GetLightComponent()->SetLightColor(NewColor);
	Item->GetLightComponent()->MarkRenderStateDirty();
	//
	Item->GetLightComponent()->PostEditChangeProperty(PropEditEvent);
	Item->GetLightComponent()->Mobility = Mobility;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void SLE_ItemColor::OnInteractivePickEnd(){}
void SLE_ItemColor::OnInteractivePickBegin(){}
void SLE_ItemColor::OnColorPickerClosed(const TSharedRef<SWindow> &Window){}

void SLE_ItemColor::OnColorPickerCancelled(FLinearColor OriginalColor) {
	if (!Item.IsValid()) {return;}
	//
	Item->SetLightColor(OriginalColor);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

FReply SLE_ItemColor::OnClickedItem(const FGeometry &Geometry, const FPointerEvent &MouseEvent) {
	if (MouseEvent.GetEffectingButton()!= EKeys::LeftMouseButton) {return FReply::Unhandled();}
	if (!Item.IsValid()) {return FReply::Unhandled();}
	//
	FColorPickerArgs PickerArgs; {
		PickerArgs.bUseAlpha = true;
		PickerArgs.bOnlyRefreshOnOk = false;
		PickerArgs.bOnlyRefreshOnMouseUp = false;
		PickerArgs.DisplayGamma = TAttribute<float>::Create(TAttribute<float>::FGetter::CreateUObject(GEngine,&UEngine::GetDisplayGamma));
		PickerArgs.OnColorPickerCancelled = FOnColorPickerCancelled::CreateSP(this,&SLE_ItemColor::OnColorPickerCancelled);
		PickerArgs.OnInteractivePickBegin = FSimpleDelegate::CreateSP(this,&SLE_ItemColor::OnInteractivePickBegin);
		PickerArgs.OnColorPickerWindowClosed = FOnWindowClosed::CreateSP(this,&SLE_ItemColor::OnColorPickerClosed);
		PickerArgs.OnInteractivePickEnd = FSimpleDelegate::CreateSP(this,&SLE_ItemColor::OnInteractivePickEnd);
		PickerArgs.OnColorCommitted = FOnLinearColorValueChanged::CreateSP(this,&SLE_ItemColor::SetColor);
		PickerArgs.InitialColorOverride = Item->GetLightColor();
		PickerArgs.ParentWidget = ColorBlock;
	} OpenColorPicker(PickerArgs);
	//
	return FReply::Handled();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool SLE_ItemColor::IsInteractable() const {
	return IsEnabled();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#undef LOCTEXT_NAMESPACE

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////